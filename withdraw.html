<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Withdraw - NAIRA TOKEN</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      background-color: #000;
      color: #FFD700;
      font-family: 'Poppins', sans-serif;
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h2 {
      text-align: center;
      margin-bottom: 20px;
    }
    .card {
      background: #111;
      border: 2px solid #FFD700;
      border-radius: 20px;
      box-shadow: 0 0 20px #FFD70060;
      padding: 20px;
      width: 90%;
      max-width: 420px;
      margin-bottom: 20px;
    }
    input, button {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      border-radius: 10px;
      border: 1px solid #FFD700;
      background: transparent;
      color: #FFD700;
      font-size: 16px;
      outline: none;
    }
    button {
      background-color: #FFD700;
      color: #000;
      font-weight: bold;
      border: none;
      cursor: pointer;
      transition: 0.3s;
    }
    button:hover {
      background: #000;
      color: #FFD700;
      border: 1px solid #FFD700;
    }
    .popup {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #111;
      color: #FFD700;
      border: 1px solid #FFD700;
      padding: 10px 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px #FFD70080;
      opacity: 0;
      animation: fadeInOut 3s forwards;
      z-index: 1000;
    }
    @keyframes fadeInOut {
      0% { opacity: 0; transform: translateX(-50%) translateY(-10px); }
      10% { opacity: 1; transform: translateX(-50%) translateY(0); }
      90% { opacity: 1; transform: translateX(-50%) translateY(0); }
      100% { opacity: 0; transform: translateX(-50%) translateY(-10px); }
    }
    .back-btn {
      position: fixed;
      top: 15px;
      left: 15px;
      background: #FFD700;
      color: #000;
      border: none;
      border-radius: 10px;
      padding: 8px 15px;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 0 10px #FFD70080;
      transition: 0.3s;
    }
    .back-btn:hover {
      background: #000;
      color: #FFD700;
      border: 1px solid #FFD700;
    }

    /* Saved bank cards */
    #savedBanks {
      margin-top: 15px;
      width: 90%;
      max-width: 420px;
    }
    .bank-card {
      background: #111;
      border: 1px solid #FFD70080;
      border-radius: 12px;
      padding: 10px 15px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: 0.3s ease;
      cursor: pointer;
    }
    .bank-card:hover {
      background: #222;
      transform: scale(1.02);
      box-shadow: 0 0 10px #FFD70050;
    }
    .bank-info {
      display: flex;
      flex-direction: column;
    }
    .delete-btn {
      background: transparent;
      border: none;
      color: #FFD700;
      font-size: 18px;
      cursor: pointer;
      transition: 0.3s;
    }
    .delete-btn:hover {
      color: red;
      transform: scale(1.2);
    }

    /* ‚ö†Ô∏è Warning card style */
    .warning-card {
      background: #1a1a1a;
      border: 1px solid #ffcc00;
      border-radius: 12px;
      padding: 15px;
      width: 90%;
      max-width: 420px;
      text-align: center;
      box-shadow: 0 0 15px #ffd70050;
      font-size: 15px;
      color: #ffeb80;
      line-height: 1.5;
      animation: fadeIn 1s ease-in;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <button class="back-btn" onclick="window.location.href='home.html'">‚Üê Home</button>
  <h2>Withdraw Funds</h2>

  <div class="card">
    <input type="text" id="bank_name" placeholder="Enter Bank Name" />
    <input type="text" id="account_number" placeholder="Enter Account Number" />
    <input type="number" id="amount" placeholder="Enter Amount (‚Ç¶)" />
    <button id="submitBtn" onclick="submitWithdraw()">Submit Request</button>
  </div>

  <!-- ‚ö†Ô∏è Stick warning message -->
  <div class="warning-card">
    ‚ö†Ô∏è <strong>Important:</strong> Please double-check all your withdrawal details before submitting.  
    Once a withdrawal order is placed, it cannot be changed or reversed.
  </div>

  <div id="savedBanks"></div>

  <script src="config.js"></script>
  <script>
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    function showPopup(msg) {
      const popup = document.createElement('div');
      popup.className = 'popup';
      popup.innerText = msg;
      document.body.appendChild(popup);
      setTimeout(() => popup.remove(), 3000);
    }

    async function loadSavedBanks() {
      const phone_number = localStorage.getItem('phone_number');
      if (!phone_number) return;
      const savedBanksContainer = document.getElementById('savedBanks');
      savedBanksContainer.innerHTML = '<p>Loading saved banks...</p>';

      const { data, error } = await supabaseClient
        .from('saved_banks')
        .select('*')
        .eq('phone_number', phone_number)
        .order('id', { ascending: false });

      if (error) {
        console.error(error);
        savedBanksContainer.innerHTML = '<p>Error loading banks.</p>';
        return;
      }

      if (!data || data.length === 0) {
        savedBanksContainer.innerHTML = '';
        return;
      }

      savedBanksContainer.innerHTML = '';
      data.forEach(bank => {
        const card = document.createElement('div');
        card.className = 'bank-card';

        const info = document.createElement('div');
        info.className = 'bank-info';
        info.innerHTML = `
          <strong>${bank.bank_name}</strong>
          <small>${bank.account_number}</small>
        `;
        info.onclick = () => fillBankDetails(bank.bank_name, bank.account_number);

        const del = document.createElement('button');
        del.className = 'delete-btn';
        del.innerText = 'üóëÔ∏è';
        del.onclick = async (e) => {
          e.stopPropagation();
          card.style.opacity = '0';
          card.style.transform = 'scale(0.9)';
          setTimeout(async () => {
            const { error } = await supabaseClient
              .from('saved_banks')
              .delete()
              .eq('id', bank.id);
            if (error) return showPopup('Failed to delete');
            showPopup('Bank deleted');
            loadSavedBanks();
          }, 300);
        };

        card.appendChild(info);
        card.appendChild(del);
        savedBanksContainer.appendChild(card);
      });
    }

    function fillBankDetails(bank, acc) {
      document.getElementById('bank_name').value = bank;
      document.getElementById('account_number').value = acc;
      showPopup('Bank details filled');
    }

    async function submitWithdraw() {
      const phone_number = localStorage.getItem('phone_number');
      const bank_name = document.getElementById('bank_name').value.trim();
      const account_number = document.getElementById('account_number').value.trim();
      const amountInput = document.getElementById('amount').value.trim();
      const amount = parseFloat(amountInput);
      const submitButton = document.getElementById('submitBtn');

      if (!phone_number) return showPopup('Please login first!');
      if (!bank_name || !account_number || isNaN(amount) || amount <= 0)
        return showPopup('Please fill all fields correctly!');

      submitButton.disabled = true;
      submitButton.textContent = "Submitting...";

      try {
        const { data: userData, error: balanceError } = await supabaseClient
          .from('users')
          .select('balance')
          .eq('phone_number', phone_number)
          .single();

        if (balanceError || !userData) throw new Error("Error fetching balance");

        const currentBalance = parseFloat(userData.balance || 0);
        const withdrawAmount = parseFloat(amount.toFixed(2));

        if (withdrawAmount > currentBalance) {
          showPopup('Insufficient balance!');
          submitButton.disabled = false;
          submitButton.textContent = "Submit Request";
          return;
        }

        const newBalance = Math.max(0, Number((currentBalance - withdrawAmount).toFixed(2)));

        const { error: withdrawError } = await supabaseClient
          .from('withdrawals')
          .insert([
            {
              phone_number,
              bank_name,
              account_number,
              amount: withdrawAmount,
              status: 'pending',
              created_at: new Date().toISOString()
            }
          ]);

        if (withdrawError) throw new Error("Failed to create withdrawal");

        const { error: updateError } = await supabaseClient
          .from('users')
          .update({ balance: newBalance })
          .eq('phone_number', phone_number);

        if (updateError) throw new Error("Failed to update balance");

        const { data: existing } = await supabaseClient
          .from('saved_banks')
          .select('*')
          .eq('phone_number', phone_number)
          .eq('bank_name', bank_name)
          .eq('account_number', account_number)
          .single();

        if (!existing) {
          await supabaseClient
            .from('saved_banks')
            .insert([{ phone_number, bank_name, account_number }]);
        }

        showPopup(`‚úÖ Withdrawal of ‚Ç¶${withdrawAmount.toLocaleString()} submitted!`);
        document.getElementById('bank_name').value = '';
        document.getElementById('account_number').value = '';
        document.getElementById('amount').value = '';
        loadSavedBanks();
      } 
      catch (err) {
        console.error(err);
        showPopup('Withdrawal failed. Please try again.');
      } 
      finally {
        submitButton.disabled = false;
        submitButton.textContent = "Submit Request";
      }
    }

    loadSavedBanks();
  </script>
</body>
</html>