<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Total Assets - NAIRA TOKEN</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="config.js"></script>

  <style>
    :root { --bg:#000; --card:#111; --gold:#FFD700; --muted:#FFD70080; }
    body {
      margin:0; font-family:'Poppins',sans-serif;
      background:var(--bg); color:var(--gold);
      padding:18px; min-height:100vh; box-sizing:border-box;
      overflow-x:hidden;
    }
    .back { background:var(--gold); color:#000; border-radius:8px; padding:8px 12px;
      border:none; font-weight:600; cursor:pointer; box-shadow:0 0 10px var(--muted) }
    h1 { text-align:center; margin:14px 0 20px; font-size:20px }
    .list { max-width:720px; margin:0 auto; display:flex; flex-direction:column;
      gap:12px; padding-bottom:120px; overflow:auto }
    .card { display:flex; align-items:center; justify-content:space-between;
      background:var(--card); border:2px solid var(--gold); padding:12px;
      border-radius:14px; box-shadow:0 0 16px var(--muted); }
    .left { display:flex; align-items:center; gap:12px }
    .logo { width:56px; height:56px; border-radius:10px; background:#000;
      display:flex; align-items:center; justify-content:center; font-size:20px;
      border:1px solid var(--muted); overflow:hidden }
    .token-info { display:flex; flex-direction:column }
    .name { font-weight:700 }
    .price { font-weight:800 }
    .small { font-size:13px; opacity:.9 }
    .action-btn { background:var(--gold); color:#000; padding:8px 12px;
      border-radius:10px; border:none; cursor:pointer; font-weight:700 }
    .modal-back { position:fixed; inset:0; background:rgba(0,0,0,.6); display:none;
      align-items:center; justify-content:center; z-index:9999 }
    .modal { background:var(--card); border:2px solid var(--gold); padding:18px;
      border-radius:12px; width:92%; max-width:420px; box-shadow:0 0 20px var(--muted);
      color:var(--gold) }
    .input { width:100%; padding:10px; border-radius:10px; border:1px solid var(--gold);
      background:transparent; color:var(--gold); margin-top:10px }
    .btn { width:100%; padding:10px; border-radius:10px; border:none;
      background:var(--gold); color:#000; font-weight:700; margin-top:10px; cursor:pointer }
    .popup { position:fixed; top:20px; left:50%; transform:translateX(-50%);
      background:var(--card); color:var(--gold); border:1px solid var(--gold);
      padding:10px 20px; border-radius:10px; box-shadow:0 0 10px var(--muted);
      opacity:0; animation:fadeInOut 3s forwards; z-index:10000 }
    @keyframes fadeInOut {
      0%{opacity:0;transform:translateX(-50%) translateY(-10px)}
      10%{opacity:1;transform:translateX(-50%) translateY(0)}
      90%{opacity:1}
      100%{opacity:0;transform:translateX(-50%) translateY(-10px)}
    }
    .empty { opacity:.9; text-align:center; padding:18px; border-radius:12px;
      border:1px dashed var(--muted); margin-top:20px }

    /* Falling Coins Animation */
    .coin {
      position: fixed;
      top: -50px;
      font-size: 24px;
      color: var(--gold);
      animation: fall 3s linear forwards;
      z-index: 9999;
      text-shadow: 0 0 8px var(--gold);
    }
    @keyframes fall {
      0% { transform: translateY(0) rotate(0deg); opacity: 1; }
      100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
    }
  </style>
</head>
<body>
  <div style="display:flex;align-items:center;justify-content:space-between;gap:12px">
    <button class="back" onclick="location.href='tokens.html'">‚Üê Tokens</button>
    <h1>Total Assets</h1>
    <div style="width:68px"></div>
  </div>

  <div id="list" class="list"><div class="empty">Loading assets...</div></div>

  <!-- Sell Modal -->
  <div id="sellModalBack" class="modal-back">
    <div class="modal">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div id="sellName" style="font-weight:700"></div>
          <div id="sellSymbol" class="small"></div>
        </div>
        <div id="sellPrice" style="font-weight:800"></div>
      </div>

      <div style="margin-top:10px" class="small">You own: <span id="ownQty">0</span> tokens</div>
      <input id="sellQty" class="input" type="number" placeholder="Enter token quantity to sell" min="0" step="0.00000001" />
      <div id="sellValue" class="small" style="margin-top:8px">You will receive: ‚Ç¶0</div>
      <button id="sellBtn" class="btn">Sell</button>
      <button style="margin-top:8px" class="input" onclick="closeSellModal()">Cancel</button>
    </div>
  </div>

  <!-- Coin sound -->
  <audio id="coinSound" src="https://assets.mixkit.co/sfx/preview/mixkit-coins-handling-1939.mp3" preload="auto"></audio>

  <script>
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const phone = localStorage.getItem('phone_number');
    const list = document.getElementById('list');
    let holdings = [];

    function showPopup(msg){
      const p=document.createElement('div');
      p.className='popup';
      p.innerText=msg;
      document.body.appendChild(p);
      setTimeout(()=>p.remove(),3000);
    }

    function triggerCoinAnimation() {
      const audio = document.getElementById("coinSound");
      audio.currentTime = 0;
      audio.play().catch(()=>{});
      for (let i = 0; i < 20; i++) {
        const coin = document.createElement("div");
        coin.className = "coin";
        coin.innerHTML = "ü™ô";
        coin.style.left = Math.random() * window.innerWidth + "px";
        coin.style.fontSize = 20 + Math.random() * 10 + "px";
        coin.style.animationDuration = (2 + Math.random()) + "s";
        document.body.appendChild(coin);
        setTimeout(() => coin.remove(), 3000);
      }
    }

    async function loadHoldings(){
      if(!phone){ showPopup('Please login first'); location.href='login.html'; return; }

      const { data:userHoldings, error:hErr } = await supabaseClient
        .from('user_token')
        .select('*')
        .eq('phone_number', phone)
        .order('updated_at',{ascending:false});

      if(hErr){ console.error(hErr); list.innerHTML='<div class="empty">Error loading holdings</div>'; return; }

      if(!userHoldings.length){ list.innerHTML='<div class="empty">You have no assets yet.</div>'; holdings=[]; return; }

      const uniqueHoldings=[]; const seen=new Set();
      for(const h of userHoldings){ if(!seen.has(h.token_id)){ uniqueHoldings.push(h); seen.add(h.token_id); } }

      const tokenIds=uniqueHoldings.map(h=>h.token_id);
      const { data:tokens, error:tErr }=await supabaseClient
        .from('tokens').select('*').in('id',tokenIds);

      if(tErr){ console.error(tErr); showPopup('Error loading tokens'); return; }

      holdings=uniqueHoldings.map(h=>({
        holding:h,
        token:tokens.find(t=>Number(t.id)===Number(h.token_id))||{}
      }));

      renderHoldings();
    }

    function renderHoldings(){
      list.innerHTML='';
      if(!holdings.length){ list.innerHTML='<div class="empty">You have no assets yet.</div>'; return; }

      holdings.forEach(item=>{
        const h=item.holding;
        const t=item.token;

        const c=document.createElement('div'); c.className='card';
        const left=document.createElement('div'); left.className='left';
        const logo=document.createElement('div'); logo.className='logo';
        if(t.logo_url){
          const img=document.createElement('img');
          img.src=t.logo_url; img.style.width='100%'; img.style.height='100%'; img.style.objectFit='cover';
          logo.appendChild(img);
        }else logo.innerText=(t.symbol||'TK').slice(0,3).toUpperCase();

        const info=document.createElement('div'); info.className='token-info';
        info.innerHTML=`<div class="name">${t.name||'Unknown Token'}</div>
                        <div class="small">Price: ‚Ç¶${Number(t.current_price||0).toLocaleString()}</div>`;
        left.append(logo,info);

        const right=document.createElement('div');
        right.style.textAlign='right';
        const qty=document.createElement('div');
        qty.className='price';
        qty.innerText=Number(h.quantity).toFixed(8);
        const value=Number(h.quantity)*Number(t.current_price||0);
        const val=document.createElement('div');
        val.className='small';
        val.innerText=`Value: ‚Ç¶${value.toLocaleString()}`;
        const spent=document.createElement('div');
        spent.className='small';
        spent.innerText=`Spent: ‚Ç¶${Number(h.amount_spent||0).toLocaleString()}`;
        right.append(qty,val,spent);

        const btn=document.createElement('button');
        btn.className='action-btn';
        btn.innerText='Sell';
        btn.onclick=()=>openSellModal(item);

        const wrap=document.createElement('div');
        wrap.style.display='flex'; wrap.style.flexDirection='column';
        wrap.style.alignItems='flex-end'; wrap.style.gap='8px';
        wrap.append(right,btn);

        c.append(left,wrap);
        list.appendChild(c);
      });
    }

    // ---------- Sell Modal ----------
    const sellModalBack=document.getElementById('sellModalBack');
    const sellName=document.getElementById('sellName');
    const sellSymbol=document.getElementById('sellSymbol');
    const sellPrice=document.getElementById('sellPrice');
    const ownQty=document.getElementById('ownQty');
    const sellQty=document.getElementById('sellQty');
    const sellValue=document.getElementById('sellValue');
    const sellBtn=document.getElementById('sellBtn');
    let currentSell=null;

    function openSellModal(item){
      // verify token still exists before opening modal
      const stillExists = holdings.find(h=>h.holding.token_id===item.holding.token_id);
      if(!stillExists){
        showPopup("‚ö†Ô∏è Token no longer available or already sold");
        loadHoldings();
        return;
      }
      currentSell=item;
      sellName.innerText=item.token.name;
      sellSymbol.innerText=item.token.symbol;
      sellPrice.innerText=`‚Ç¶${Number(item.token.current_price).toLocaleString()}`;
      ownQty.innerText=Number(item.holding.quantity).toFixed(8);
      sellQty.value='';
      sellValue.innerText='You will receive: ‚Ç¶0';
      sellModalBack.style.display='flex';
    }

    function closeSellModal(){ sellModalBack.style.display='none'; currentSell=null; }

    sellQty.addEventListener('input',()=>{
      const q=parseFloat(sellQty.value)||0;
      const val=q*Number(currentSell?.token?.current_price||0);
      sellValue.innerText=`You will receive: ‚Ç¶${val.toLocaleString()}`;
    });

    // ‚úÖ Sell Logic + Immediate refresh + Protection
    sellBtn.addEventListener('click', async ()=>{
      if(!currentSell) return;
      const q=parseFloat(sellQty.value);
      if(!q||q<=0){ showPopup('Enter a valid quantity'); return; }
      const available=Number(currentSell.holding.quantity);
      if(q>available){ showPopup('You do not have enough tokens'); return; }

      sellBtn.disabled=true;
      showPopup('Processing sale...');

      const price=Number(currentSell.token.current_price||0);
      const credit=Number((q*price).toFixed(2));
      const remaining=Number((available-q).toFixed(8));
      const spent=Number(currentSell.holding.amount_spent||0);
      const newSpent=(available>0)?Number((spent*(remaining/available)).toFixed(2)):0;

      try{
        // double-check if token still exists before selling
        const { data:checkExist } = await supabaseClient
          .from('user_token')
          .select('quantity')
          .match({phone_number:phone,token_id:currentSell.token.id})
          .maybeSingle();

        if(!checkExist){ showPopup("‚ö†Ô∏è Token already sold or removed."); closeSellModal(); loadHoldings(); return; }

        if(remaining<=0){
          await supabaseClient.from('user_token')
            .delete()
            .match({phone_number:phone,token_id:currentSell.token.id});
        }else{
          await supabaseClient.from('user_token')
            .update({quantity:remaining,amount_spent:newSpent})
            .match({phone_number:phone,token_id:currentSell.token.id});
        }

        const { data:userData } = await supabaseClient
          .from('users').select('balance').eq('phone_number', phone).single();

        const newBal = Number(userData.balance || 0) + credit;
        await supabaseClient.from('users')
          .update({ balance: newBal })
          .eq('phone_number', phone);

        triggerCoinAnimation();
        showPopup(`‚úÖ Sold successfully ‚Äî ‚Ç¶${credit.toLocaleString()} credited`);
        closeSellModal();

        // immediate refresh so token disappears
        await loadHoldings();

        // store for trophy on homepage
        localStorage.setItem('recent_win', credit);
        setTimeout(()=>window.location.href='home.html',1500);

      }catch(e){
        console.error(e);
        showPopup('Sell failed');
        sellBtn.disabled=false;
      }
      sellBtn.disabled=false;
    });

    sellModalBack.addEventListener('click',e=>{if(e.target===sellModalBack)closeSellModal();});

    (async function init(){
      if(!phone){ location.href='login.html'; return; }
      await loadHoldings();
      setInterval(loadHoldings,15000);
    })();
  </script>
</body>
</html>